{% extends "base.html" %}

{% block title %}Approval Dashboard - Construction Site Material Tracker{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>
                <i class="fas fa-check-circle me-2"></i>
                Material Issuance Approvals
            </h2>
            <div>
                <a href="{{ url_for('site_engineer') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>
                    Back to Dashboard
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Pending Requests -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-clock me-2"></i>
                    Pending Individual Requests
                    {% if pending_requests %}
                        <span class="badge bg-warning ms-2">{{ pending_requests|length }}</span>
                    {% endif %}
                </h5>
            </div>
            <div class="card-body">
                {% if pending_requests %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Material</th>
                                    <th>Quantity</th>
                                    <th>Requested By</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for request in pending_requests %}
                                <tr>
                                    <td>{{ request.requested_at.strftime('%m/%d %H:%M') }}</td>
                                    <td>{{ request.material_name }}</td>
                                    <td>{{ request.quantity_requested }} {{ request.unit }}</td>
                                    <td>{{ request.requested_by }}</td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <button class="btn btn-sm btn-success" onclick="approveRequest({{ request.id }}, '{{ request.material_name }}', {{ request.quantity_requested }}, '{{ request.unit }}')">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button class="btn btn-sm btn-danger" onclick="denyRequest({{ request.id }}, '{{ request.material_name }}')">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-clipboard-check fa-2x mb-2"></i>
                        <p>No pending individual requests.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-truck-loading me-2"></i>
                    Pending Batch Requests
                    {% if pending_batch_requests %}
                        <span class="badge bg-warning ms-2">{{ pending_batch_requests|length }}</span>
                    {% endif %}
                </h5>
            </div>
            <div class="card-body">
                {% if pending_batch_requests %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Batch ID</th>
                                    <th>Issued To</th>
                                    <th>Truck</th>
                                    <th>Requested By</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for batch in pending_batch_requests %}
                                <tr>
                                    <td>{{ batch.batch_id }}</td>
                                    <td>{{ batch.issued_to }}</td>
                                    <td>{{ batch.truck_number or '-' }}</td>
                                    <td>{{ batch.requested_by }}</td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <button class="btn btn-sm btn-info" onclick="showBatchDetails('{{ batch.batch_id }}')">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button class="btn btn-sm btn-success" onclick="approveBatch('{{ batch.batch_id }}', '{{ batch.issued_to }}')">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button class="btn btn-sm btn-danger" onclick="denyBatch('{{ batch.batch_id }}', '{{ batch.issued_to }}')">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-truck-loading fa-2x mb-2"></i>
                        <p>No pending batch requests.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Recent Decisions -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-history me-2"></i>
                    Recent Approval Decisions
                </h5>
            </div>
            <div class="card-body">
                {% if recent_decisions %}
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Material</th>
                                    <th>Quantity</th>
                                    <th>Requested By</th>
                                    <th>Decision</th>
                                    <th>Notes</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for decision in recent_decisions %}
                                <tr>
                                    <td>{{ decision.reviewed_at.strftime('%m/%d/%Y %H:%M') }}</td>
                                    <td>{{ decision.material_name }}</td>
                                    <td>{{ decision.quantity_requested }} {{ decision.unit }}</td>
                                    <td>{{ decision.requested_by }}</td>
                                    <td>
                                        <span class="badge bg-{{ 'success' if decision.status == 'approved' else 'danger' }}">
                                            {{ decision.status.title() }}
                                        </span>
                                    </td>
                                    <td>{{ decision.review_notes or '-' }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-clipboard-list fa-3x mb-3"></i>
                        <p>No approval decisions yet.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Approval Modal -->
<div class="modal fade" id="approvalModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="approvalModalTitle">Approve Material Request</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('process_approval') }}">
                <div class="modal-body">
                    <input type="hidden" name="request_id" id="modalRequestId">
                    <input type="hidden" name="action" id="modalAction">
                    
                    <div class="mb-3">
                        <label class="form-label">Material & Quantity</label>
                        <input type="text" class="form-control" id="modalMaterialInfo" readonly>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Review Notes</label>
                        <textarea class="form-control" name="review_notes" id="modalReviewNotes" rows="3" placeholder="Add any notes about this decision..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn" id="modalSubmitBtn">Confirm Decision</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Batch Approval Modal -->
<div class="modal fade" id="batchApprovalModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="batchApprovalModalTitle">Approve Batch Request</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('process_batch_approval') }}">
                <div class="modal-body">
                    <input type="hidden" name="batch_id" id="modalBatchId">
                    <input type="hidden" name="action" id="modalBatchAction">
                    
                    <div class="mb-3">
                        <label class="form-label">Batch ID & Recipient</label>
                        <input type="text" class="form-control" id="modalBatchInfo" readonly>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Review Notes</label>
                        <textarea class="form-control" name="review_notes" id="modalBatchReviewNotes" rows="3" placeholder="Add any notes about this decision..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn" id="modalBatchSubmitBtn">Confirm Decision</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
function approveRequest(requestId, materialName, quantity, unit) {
    document.getElementById('modalRequestId').value = requestId;
    document.getElementById('modalAction').value = 'approve';
    document.getElementById('modalMaterialInfo').value = materialName + ' - ' + quantity + ' ' + unit;
    document.getElementById('approvalModalTitle').textContent = 'Approve Material Request';
    document.getElementById('modalSubmitBtn').textContent = 'Approve Request';
    document.getElementById('modalSubmitBtn').className = 'btn btn-success';
    
    const modal = new bootstrap.Modal(document.getElementById('approvalModal'));
    modal.show();
}

function denyRequest(requestId, materialName) {
    document.getElementById('modalRequestId').value = requestId;
    document.getElementById('modalAction').value = 'deny';
    document.getElementById('modalMaterialInfo').value = materialName;
    document.getElementById('approvalModalTitle').textContent = 'Deny Material Request';
    document.getElementById('modalSubmitBtn').textContent = 'Deny Request';
    document.getElementById('modalSubmitBtn').className = 'btn btn-danger';
    
    const modal = new bootstrap.Modal(document.getElementById('approvalModal'));
    modal.show();
}

function approveBatch(batchId, recipient) {
    document.getElementById('modalBatchId').value = batchId;
    document.getElementById('modalBatchAction').value = 'approve';
    document.getElementById('modalBatchInfo').value = batchId + ' - ' + recipient;
    document.getElementById('batchApprovalModalTitle').textContent = 'Approve Batch Request';
    document.getElementById('modalBatchSubmitBtn').textContent = 'Approve Batch';
    document.getElementById('modalBatchSubmitBtn').className = 'btn btn-success';
    
    const modal = new bootstrap.Modal(document.getElementById('batchApprovalModal'));
    modal.show();
}

function denyBatch(batchId, recipient) {
    document.getElementById('modalBatchId').value = batchId;
    document.getElementById('modalBatchAction').value = 'deny';
    document.getElementById('modalBatchInfo').value = batchId + ' - ' + recipient;
    document.getElementById('batchApprovalModalTitle').textContent = 'Deny Batch Request';
    document.getElementById('modalBatchSubmitBtn').textContent = 'Deny Batch';
    document.getElementById('modalBatchSubmitBtn').className = 'btn btn-danger';
    
    const modal = new bootstrap.Modal(document.getElementById('batchApprovalModal'));
    modal.show();
}

function showBatchDetails(batchId) {
    // This could be expanded to show detailed batch information
    alert('Batch Details for ' + batchId + ' - This feature can be enhanced to show detailed material list');
}
</script>
{% endblock %}