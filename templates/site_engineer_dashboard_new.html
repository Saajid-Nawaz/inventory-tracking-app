{% extends "base_new.html" %}

{% block title %}Site Engineer Dashboard - Multi-Site Management{% endblock %}

{% block content %}
<!-- Header Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm bg-gradient-success text-white">
            <div class="card-body py-4">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <div class="d-flex align-items-center">
                            <div class="bg-white bg-opacity-25 rounded-3 p-3 me-3">
                                <i class="fas fa-hard-hat fa-2x text-white"></i>
                            </div>
                            <div>
                                <h3 class="mb-1 fw-bold">Welcome, {{ current_user.username }}</h3>
                                <p class="mb-0 opacity-90">Site Engineer - Multi-Site Inventory Management</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 text-end">
                        <div class="text-white">
                            <div class="h4 mb-0">{{ sites|length }} Active Sites</div>
                            <div class="opacity-75">{{ current_time.strftime('%B %d, %Y') if current_time else 'August 14, 2025' }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Key Metrics -->
<div class="row g-3 mb-4">
    <div class="col-xl-3 col-md-6">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body p-4">
                <div class="d-flex align-items-center">
                    <div class="flex-shrink-0">
                        <div class="bg-primary bg-opacity-10 rounded-3 p-3">
                            <i class="fas fa-building fa-2x text-primary"></i>
                        </div>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <div class="h4 mb-0 text-dark">{{ total_sites }}</div>
                        <div class="text-muted">Construction Sites</div>
                        <small class="text-muted">Active locations</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body p-4">
                <div class="d-flex align-items-center">
                    <div class="flex-shrink-0">
                        <div class="bg-success bg-opacity-10 rounded-3 p-3">
                            <i class="fas fa-cubes fa-2x text-success"></i>
                        </div>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <div class="h4 mb-0 text-dark">{{ total_materials }}</div>
                        <div class="text-muted">Material Types</div>
                        <small class="text-muted">In catalog</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body p-4">
                <div class="d-flex align-items-center">
                    <div class="flex-shrink-0">
                        <div class="bg-warning bg-opacity-10 rounded-3 p-3">
                            <i class="fas fa-clock fa-2x text-warning"></i>
                        </div>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <div class="h4 mb-0 text-dark">{{ pending_approvals }}</div>
                        <div class="text-muted">Pending Approvals</div>
                        <small class="text-muted">Need attention</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body p-4">
                <div class="d-flex align-items-center">
                    <div class="flex-shrink-0">
                        <div class="bg-info bg-opacity-10 rounded-3 p-3">
                            <i class="fas fa-exchange-alt fa-2x text-info"></i>
                        </div>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <div class="h4 mb-0 text-dark">{{ today_receipts + today_issues }}</div>
                        <div class="text-muted">Today's Activity</div>
                        <small class="text-muted">Transactions</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Management Tools -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-bottom py-3">
                <div class="d-flex align-items-center">
                    <div class="bg-dark bg-opacity-10 rounded-2 p-2 me-3">
                        <i class="fas fa-tools text-dark"></i>
                    </div>
                    <h5 class="mb-0 fw-bold">Management Tools</h5>
                </div>
            </div>
            <div class="card-body p-4">
                <!-- Primary Management Tools -->
                <div class="row g-3">
                    <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6">
                        <a href="{{ url_for('manage_sites') }}" class="card border-0 shadow-lg h-100 text-decoration-none position-relative overflow-hidden">
                            <div class="card-body text-center p-4 bg-gradient position-relative">
                                <div class="bg-primary bg-opacity-15 rounded-circle p-3 mx-auto mb-3 d-inline-flex">
                                    <i class="fas fa-map-marker-alt fa-2x text-primary"></i>
                                </div>
                                <h6 class="fw-bold text-dark mb-1">Manage Sites</h6>
                                <p class="text-muted small mb-0">Locations</p>
                            </div>
                            <div class="position-absolute top-0 end-0 p-2">
                                <span class="badge bg-primary">Admin</span>
                            </div>
                        </a>
                    </div>
                    <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6">
                        <a href="{{ url_for('manage_materials') }}" class="card border-0 shadow-lg h-100 text-decoration-none position-relative overflow-hidden">
                            <div class="card-body text-center p-4 bg-gradient position-relative">
                                <div class="bg-success bg-opacity-15 rounded-circle p-3 mx-auto mb-3 d-inline-flex">
                                    <i class="fas fa-cubes fa-2x text-success"></i>
                                </div>
                                <h6 class="fw-bold text-dark mb-1">Materials</h6>
                                <p class="text-muted small mb-0">Catalog</p>
                            </div>
                            <div class="position-absolute top-0 end-0 p-2">
                                <span class="badge bg-success">94+</span>
                            </div>
                        </a>
                    </div>
                    <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6">
                        <a href="{{ url_for('manage_users') }}" class="card border-0 shadow-lg h-100 text-decoration-none position-relative overflow-hidden">
                            <div class="card-body text-center p-4 bg-gradient position-relative">
                                <div class="bg-info bg-opacity-15 rounded-circle p-3 mx-auto mb-3 d-inline-flex">
                                    <i class="fas fa-users fa-2x text-info"></i>
                                </div>
                                <h6 class="fw-bold text-dark mb-1">Users</h6>
                                <p class="text-muted small mb-0">Access control</p>
                            </div>
                        </a>
                    </div>
                    <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6">
                        <a href="{{ url_for('approve_requests') }}" class="card border-0 shadow-lg h-100 text-decoration-none position-relative overflow-hidden">
                            <div class="card-body text-center p-4 bg-gradient position-relative">
                                <div class="bg-warning bg-opacity-15 rounded-circle p-3 mx-auto mb-3 d-inline-flex">
                                    <i class="fas fa-check-circle fa-2x text-warning"></i>
                                </div>
                                <h6 class="fw-bold text-dark mb-1">Approvals</h6>
                                <p class="text-muted small mb-0">Review</p>
                            </div>
                            {% if pending_approvals > 0 %}
                            <div class="position-absolute top-0 end-0 p-2">
                                <span class="badge bg-warning text-dark">{{ pending_approvals }}</span>
                            </div>
                            {% endif %}
                        </a>
                    </div>
                    <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6">
                        <a href="{{ url_for('stock_transfer') }}" class="card border-0 shadow-lg h-100 text-decoration-none position-relative overflow-hidden">
                            <div class="card-body text-center p-4 bg-gradient position-relative">
                                <div class="bg-secondary bg-opacity-15 rounded-circle p-3 mx-auto mb-3 d-inline-flex">
                                    <i class="fas fa-truck fa-2x text-secondary"></i>
                                </div>
                                <h6 class="fw-bold text-dark mb-1">Transfer</h6>
                                <p class="text-muted small mb-0">Inter-site</p>
                            </div>
                        </a>
                    </div>
                    <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6">
                        <a href="{{ url_for('reports') }}" class="card border-0 shadow-lg h-100 text-decoration-none position-relative overflow-hidden">
                            <div class="card-body text-center p-4 bg-gradient position-relative">
                                <div class="bg-dark bg-opacity-15 rounded-circle p-3 mx-auto mb-3 d-inline-flex">
                                    <i class="fas fa-chart-line fa-2x text-dark"></i>
                                </div>
                                <h6 class="fw-bold text-dark mb-1">Reports</h6>
                                <p class="text-muted small mb-0">Analytics</p>
                            </div>
                        </a>
                    </div>
                </div>
                
                <!-- Operations & Inventory Tools -->
                <div class="row g-3 mt-3">
                    <div class="col-lg-2 col-md-4 col-sm-6">
                        <a href="{{ url_for('bulk_receive_materials') }}" class="card border-0 shadow-sm h-100 text-decoration-none bg-success bg-opacity-10">
                            <div class="card-body text-center p-3">
                                <div class="d-flex align-items-center justify-content-center">
                                    <i class="fas fa-boxes fa-lg text-success me-2"></i>
                                    <div class="text-start">
                                        <div class="fw-bold small text-dark">Bulk Receive</div>
                                        <small class="text-muted">Multiple materials</small>
                                    </div>
                                </div>
                            </div>
                        </a>
                    </div>
                    <div class="col-lg-2 col-md-4 col-sm-6">
                        <a href="{{ url_for('stock_adjustments') }}" class="card border-0 shadow-sm h-100 text-decoration-none bg-warning bg-opacity-10">
                            <div class="card-body text-center p-3">
                                <div class="d-flex align-items-center justify-content-center">
                                    <i class="fas fa-tools fa-lg text-warning me-2"></i>
                                    <div class="text-start">
                                        <div class="fw-bold small text-dark">Stock Adjustments</div>
                                        <small class="text-muted">Physical count</small>
                                    </div>
                                </div>
                            </div>
                        </a>
                    </div>
                    <div class="col-lg-2 col-md-4 col-sm-6">
                        <a href="{{ url_for('batch_operations') }}" class="card border-0 shadow-sm h-100 text-decoration-none bg-info bg-opacity-10">
                            <div class="card-body text-center p-3">
                                <div class="d-flex align-items-center justify-content-center">
                                    <i class="fas fa-layer-group fa-lg text-info me-2"></i>
                                    <div class="text-start">
                                        <div class="fw-bold small text-dark">Batch Operations</div>
                                        <small class="text-muted">Mass processing</small>
                                    </div>
                                </div>
                            </div>
                        </a>
                    </div>
                    <div class="col-lg-2 col-md-4 col-sm-6">
                        <a href="{{ url_for('transaction_history') }}" class="card border-0 shadow-sm h-100 text-decoration-none bg-secondary bg-opacity-10">
                            <div class="card-body text-center p-3">
                                <div class="d-flex align-items-center justify-content-center">
                                    <i class="fas fa-history fa-lg text-secondary me-2"></i>
                                    <div class="text-start">
                                        <div class="fw-bold small text-dark">Transaction History</div>
                                        <small class="text-muted">Full audit trail</small>
                                    </div>
                                </div>
                            </div>
                        </a>
                    </div>
                    <div class="col-lg-2 col-md-4 col-sm-6">
                        <a href="{{ url_for('system_settings') }}" class="card border-0 shadow-sm h-100 text-decoration-none bg-dark bg-opacity-10">
                            <div class="card-body text-center p-3">
                                <div class="d-flex align-items-center justify-content-center">
                                    <i class="fas fa-cog fa-lg text-dark me-2"></i>
                                    <div class="text-start">
                                        <div class="fw-bold small text-dark">System Settings</div>
                                        <small class="text-muted">Configuration</small>
                                    </div>
                                </div>
                            </div>
                        </a>
                    </div>
                    <div class="col-lg-2 col-md-4 col-sm-6">
                        <a href="{{ url_for('excel_operations') }}" class="card border-0 shadow-sm h-100 text-decoration-none bg-danger bg-opacity-10">
                            <div class="card-body text-center p-3">
                                <div class="d-flex align-items-center justify-content-center">
                                    <i class="fas fa-file-excel fa-lg text-danger me-2"></i>
                                    <div class="text-start">
                                        <div class="fw-bold small text-dark">Excel Operations</div>
                                        <small class="text-muted">Import/Export</small>
                                    </div>
                                </div>
                            </div>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Main Content Row -->
<div class="row g-4">
    <!-- Site Overview -->
    <div class="col-lg-8">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-white border-bottom py-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <div class="bg-primary bg-opacity-10 rounded-2 p-2 me-3">
                            <i class="fas fa-building text-primary"></i>
                        </div>
                        <h5 class="mb-0 fw-bold">Site Overview</h5>
                    </div>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary active" onclick="showSiteView('overview')">Overview</button>
                        <button class="btn btn-outline-primary" onclick="showSiteView('stock')">Stock Levels</button>
                        <button class="btn btn-outline-primary" onclick="showSiteView('activity')">Activity</button>
                    </div>
                </div>
            </div>
            <div class="card-body p-4">
                <div id="siteOverview">
                    {% if sites %}
                    <div class="row g-3">
                        {% for site in sites %}
                        <div class="col-lg-6">
                            <div class="card border h-100">
                                <div class="card-body p-4">
                                    <div class="d-flex justify-content-between align-items-start mb-3">
                                        <div>
                                            <h6 class="fw-bold mb-1">{{ site.name }}</h6>
                                            <p class="text-muted small mb-0">{{ site.location }}</p>
                                        </div>
                                        <span class="badge bg-success">Active</span>
                                    </div>
                                    
                                    <div class="row text-center g-3 mb-3">
                                        <div class="col-4">
                                            <div class="bg-primary bg-opacity-10 rounded-2 p-2 mb-1">
                                                <i class="fas fa-boxes text-primary"></i>
                                            </div>
                                            <div class="fw-bold text-dark">{{ site.stock_levels|length if site.stock_levels else 0 }}</div>
                                            <small class="text-muted">Items</small>
                                        </div>
                                        <div class="col-4">
                                            <div class="bg-success bg-opacity-10 rounded-2 p-2 mb-1">
                                                <i class="fas fa-users text-success"></i>
                                            </div>
                                            <div class="fw-bold text-dark">{{ site.users|length if site.users else 0 }}</div>
                                            <small class="text-muted">Staff</small>
                                        </div>
                                        <div class="col-4">
                                            <div class="bg-info bg-opacity-10 rounded-2 p-2 mb-1">
                                                <i class="fas fa-dollar-sign text-info"></i>
                                            </div>
                                            <div class="fw-bold text-dark">ZMW {{ "%.0f"|format(site.total_value if site.total_value else 0) }}</div>
                                            <small class="text-muted">Value</small>
                                        </div>
                                    </div>
                                    
                                    <div class="btn-group w-100" role="group">
                                        <a href="{{ url_for('view_stock', site_id=site.id) }}" class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-eye me-1"></i>View
                                        </a>
                                        <a href="{{ url_for('receive_materials', site_id=site.id) }}" class="btn btn-sm btn-outline-success">
                                            <i class="fas fa-plus me-1"></i>Receive
                                        </a>
                                        <a href="{{ url_for('reports', site_id=site.id) }}" class="btn btn-sm btn-outline-info">
                                            <i class="fas fa-chart-bar me-1"></i>Report
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-building fa-3x text-muted mb-3"></i>
                        <h6 class="text-muted">No sites available</h6>
                        <p class="text-muted">Create your first construction site</p>
                        <a href="{{ url_for('manage_sites') }}" class="btn btn-primary">
                            <i class="fas fa-plus me-2"></i>Add Site
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Alerts & Notifications -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white border-bottom py-3">
                <div class="d-flex align-items-center">
                    <div class="bg-warning bg-opacity-10 rounded-2 p-2 me-3">
                        <i class="fas fa-bell text-warning"></i>
                    </div>
                    <h6 class="mb-0 fw-bold">Alerts & Notifications</h6>
                </div>
            </div>
            <div class="card-body p-3">
                {% if low_stock_alerts %}
                    {% for alert in low_stock_alerts[:5] %}
                    <div class="d-flex align-items-center p-3 bg-warning bg-opacity-10 rounded-3 mb-2">
                        <div class="flex-shrink-0 me-3">
                            <div class="bg-warning rounded-2 p-2">
                                <i class="fas fa-exclamation-triangle text-white"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1">
                            <div class="fw-bold small">{{ alert.material.name if alert.material else 'Unknown' }}</div>
                            <div class="text-muted small">Low stock at {{ alert.site.name if alert.site else 'Unknown Site' }}</div>
                        </div>
                        <div class="text-end">
                            <span class="badge bg-warning text-dark">{{ alert.quantity }}</span>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                <div class="text-center py-3">
                    <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                    <p class="text-muted small mb-0">All stock levels normal</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-bottom py-3">
                <div class="d-flex align-items-center">
                    <div class="bg-info bg-opacity-10 rounded-2 p-2 me-3">
                        <i class="fas fa-chart-bar text-info"></i>
                    </div>
                    <h6 class="mb-0 fw-bold">Today's Summary</h6>
                </div>
            </div>
            <div class="card-body p-4">
                <div class="row g-3 text-center">
                    <div class="col-6">
                        <div class="bg-success bg-opacity-10 rounded-3 p-3">
                            <div class="h5 mb-0 text-success">{{ today_receipts }}</div>
                            <small class="text-muted">Receipts</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="bg-primary bg-opacity-10 rounded-3 p-3">
                            <div class="h5 mb-0 text-primary">{{ today_issues }}</div>
                            <small class="text-muted">Issues</small>
                        </div>
                    </div>
                </div>
                
                <hr class="my-3">
                
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="small">Individual Requests</span>
                    <span class="badge bg-warning">{{ pending_individual_requests }}</span>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="small">Batch Requests</span>
                    <span class="badge bg-info">{{ pending_batch_requests }}</span>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                    <span class="small">Transfer Requests</span>
                    <span class="badge bg-secondary">{{ pending_transfer_requests }}</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Transactions -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-bottom py-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <div class="bg-secondary bg-opacity-10 rounded-2 p-2 me-3">
                            <i class="fas fa-history text-secondary"></i>
                        </div>
                        <h5 class="mb-0 fw-bold">Recent Transactions</h5>
                    </div>
                    <a href="{{ url_for('reports') }}" class="btn btn-outline-primary btn-sm">
                        View All <i class="fas fa-arrow-right ms-1"></i>
                    </a>
                </div>
            </div>
            <div class="card-body p-0">
                {% if recent_transactions %}
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="px-4 py-3 border-0">Date & Time</th>
                                <th class="px-3 py-3 border-0">Type</th>
                                <th class="px-3 py-3 border-0">Material</th>
                                <th class="px-3 py-3 border-0">Quantity</th>
                                <th class="px-3 py-3 border-0">Site</th>
                                <th class="px-3 py-3 border-0">User</th>
                                <th class="px-3 py-3 border-0">Value</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for transaction in recent_transactions[:10] %}
                            <tr>
                                <td class="px-4 py-3">
                                    <div class="fw-bold">{{ transaction.created_at.strftime('%m/%d/%Y') if transaction.created_at else 'N/A' }}</div>
                                    <small class="text-muted">{{ transaction.created_at.strftime('%I:%M %p') if transaction.created_at else 'N/A' }}</small>
                                </td>
                                <td class="px-3 py-3">
                                    <span class="badge bg-{{ 'success' if transaction.type == 'receive' else 'primary' if transaction.type == 'issue' else 'warning' }}">
                                        <i class="fas fa-{{ 'plus' if transaction.type == 'receive' else 'minus' if transaction.type == 'issue' else 'exchange-alt' }} me-1"></i>
                                        {{ transaction.type.title() if transaction.type else 'Transaction' }}
                                    </span>
                                </td>
                                <td class="px-3 py-3">
                                    <div class="fw-bold">{{ transaction.material.name if transaction.material else 'Unknown' }}</div>
                                    {% if transaction.material and transaction.material.category %}
                                    <small class="text-muted">{{ transaction.material.category }}</small>
                                    {% endif %}
                                </td>
                                <td class="px-3 py-3">
                                    <span class="fw-bold">{{ transaction.quantity }}</span>
                                    <small class="text-muted">{{ transaction.material.unit if transaction.material else '' }}</small>
                                </td>
                                <td class="px-3 py-3">{{ transaction.site.name if transaction.site else 'N/A' }}</td>
                                <td class="px-3 py-3">{{ transaction.creator_user.username if transaction.creator_user else 'System' }}</td>
                                <td class="px-3 py-3">
                                    {% if transaction.unit_cost %}
                                    ZMW {{ "%.2f"|format(transaction.quantity * transaction.unit_cost) }}
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-history fa-3x text-muted mb-3"></i>
                    <h6 class="text-muted">No recent transactions</h6>
                    <p class="text-muted">Transaction history will appear here</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function showSiteView(view) {
    // Toggle active button
    document.querySelectorAll('.btn-group .btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    // Show different content based on view
    console.log('Showing ' + view + ' view');
}

// Auto-refresh every 5 minutes
setInterval(function() {
    window.location.reload();
}, 300000);
</script>
{% endblock %}